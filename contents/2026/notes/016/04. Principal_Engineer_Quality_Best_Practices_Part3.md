# Principal Engineer: Mastering Quality and Best Practices Enforcement

## Part 3: Testing Strategies (Unit, Integration, E2E)

---

## Table of Contents

1. [Testing Pyramid](#1-testing-pyramid)
2. [Unit Testing](#2-unit-testing)
3. [Integration Testing](#3-integration-testing)
4. [End-to-End Testing](#4-end-to-end-testing)
5. [Test-Driven Development](#5-test-driven-development)
6. [Testing Best Practices](#6-testing-best-practices)
7. [Practical Examples](#7-practical-examples)

---

## 1. Testing Pyramid

### 1.1 Testing Pyramid Structure

```
        /\
       /  \      E2E Tests (Few, Slow, Expensive)
      /────\
     /      \    Integration Tests (Some, Medium)
    /────────\
   /          \  Unit Tests (Many, Fast, Cheap)
  /────────────\
```

**Distribution**:
- **Unit Tests**: 70% of tests
- **Integration Tests**: 20% of tests
- **E2E Tests**: 10% of tests

### 1.2 Why Testing Pyramid?

**Benefits**:
- **Fast Feedback**: Unit tests run quickly
- **Cost Effective**: Catch bugs early
- **Maintainable**: Easier to maintain unit tests
- **Confidence**: Comprehensive coverage

---

## 2. Unit Testing

### 2.1 What is Unit Testing?

**Definition**: Test individual units of code in isolation

**Characteristics**:
- Fast (< 1ms per test)
- Isolated (no dependencies)
- Deterministic (same input = same output)
- Repeatable

### 2.2 Unit Test Structure (AAA Pattern)

```java
@Test
void testMethodName_Scenario_ExpectedBehavior() {
    // Arrange: Set up test data
    User user = new User("John", "john@example.com");
    UserService userService = new UserService(mockRepository);
    
    // Act: Execute the method
    User result = userService.createUser(user);
    
    // Assert: Verify the result
    assertNotNull(result);
    assertEquals("John", result.getName());
}
```

### 2.3 Unit Testing Examples

**Example 1: Service with Mocking**
```java
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private EmailService emailService;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void testCreateUser_Success_ReturnsUser() {
        // Arrange
        User user = new User("John", "john@example.com");
        when(userRepository.save(any(User.class))).thenReturn(user);
        doNothing().when(emailService).sendWelcomeEmail(anyString());
        
        // Act
        User result = userService.createUser(user);
        
        // Assert
        assertNotNull(result);
        assertEquals("John", result.getName());
        verify(userRepository).save(user);
        verify(emailService).sendWelcomeEmail("john@example.com");
    }
    
    @Test
    void testCreateUser_InvalidEmail_ThrowsException() {
        // Arrange
        User user = new User("John", "invalid-email");
        
        // Act & Assert
        assertThrows(IllegalArgumentException.class, 
            () -> userService.createUser(user));
        verify(userRepository, never()).save(any());
    }
}
```

**Example 2: Testing Business Logic**
```java
class DiscountCalculatorTest {
    
    private DiscountCalculator calculator = new DiscountCalculator();
    
    @Test
    void testCalculateDiscount_HighOrder_Returns10Percent() {
        // Arrange
        double total = 1500.0;
        
        // Act
        double discount = calculator.calculateDiscount(total);
        
        // Assert
        assertEquals(150.0, discount, 0.01);
    }
    
    @Test
    void testCalculateDiscount_MediumOrder_Returns5Percent() {
        // Arrange
        double total = 750.0;
        
        // Act
        double discount = calculator.calculateDiscount(total);
        
        // Assert
        assertEquals(37.5, discount, 0.01);
    }
    
    @Test
    void testCalculateDiscount_LowOrder_ReturnsZero() {
        // Arrange
        double total = 100.0;
        
        // Act
        double discount = calculator.calculateDiscount(total);
        
        // Assert
        assertEquals(0.0, discount, 0.01);
    }
    
    @Test
    void testCalculateDiscount_EdgeCase_ReturnsCorrectDiscount() {
        // Test boundary conditions
        assertEquals(0.0, calculator.calculateDiscount(500.0), 0.01);
        assertEquals(25.0, calculator.calculateDiscount(500.01), 0.01);
    }
}
```

**Example 3: Testing Edge Cases**
```java
class StringUtilsTest {
    
    @Test
    void testReverse_NullString_ThrowsException() {
        assertThrows(NullPointerException.class, 
            () -> StringUtils.reverse(null));
    }
    
    @Test
    void testReverse_EmptyString_ReturnsEmpty() {
        assertEquals("", StringUtils.reverse(""));
    }
    
    @Test
    void testReverse_SingleCharacter_ReturnsSame() {
        assertEquals("a", StringUtils.reverse("a"));
    }
    
    @Test
    void testReverse_NormalString_ReturnsReversed() {
        assertEquals("cba", StringUtils.reverse("abc"));
    }
}
```

### 2.4 Unit Testing Best Practices

**1. Test One Thing**
```java
// BAD: Testing multiple things
@Test
void testUserService() {
    userService.createUser(user);
    userService.updateUser(user);
    userService.deleteUser(user.getId());
    // Too many assertions, unclear what's being tested
}

// GOOD: One test per scenario
@Test
void testCreateUser_Success_ReturnsUser() {
    // Test only creation
}

@Test
void testUpdateUser_Success_ReturnsUpdatedUser() {
    // Test only update
}
```

**2. Use Descriptive Names**
```java
// BAD: Unclear
@Test
void test1() { }

@Test
void testUser() { }

// GOOD: Clear and descriptive
@Test
void testCreateUser_WithValidData_ReturnsUserWithId() { }

@Test
void testCreateUser_WithInvalidEmail_ThrowsIllegalArgumentException() { }
```

**3. Test Edge Cases**
```java
@Test
void testCalculateTotal_WithNullItems_ThrowsException() {
    assertThrows(NullPointerException.class, 
        () -> calculator.calculateTotal(null));
}

@Test
void testCalculateTotal_WithEmptyItems_ReturnsZero() {
    assertEquals(0.0, calculator.calculateTotal(Collections.emptyList()));
}

@Test
void testCalculateTotal_WithNegativePrice_ThrowsException() {
    List<Item> items = Arrays.asList(new Item("test", -10.0));
    assertThrows(IllegalArgumentException.class, 
        () -> calculator.calculateTotal(items));
}
```

**4. Use Test Fixtures**
```java
class UserServiceTest {
    
    private User validUser;
    private User invalidUser;
    
    @BeforeEach
    void setUp() {
        validUser = new User("John", "john@example.com");
        invalidUser = new User("", "invalid-email");
    }
    
    @Test
    void testCreateUser_WithValidUser_Success() {
        // Use validUser
    }
    
    @Test
    void testCreateUser_WithInvalidUser_ThrowsException() {
        // Use invalidUser
    }
}
```

---

## 3. Integration Testing

### 3.1 What is Integration Testing?

**Definition**: Test interaction between components

**Characteristics**:
- Tests real dependencies
- Slower than unit tests
- Tests integration points
- May use test database

### 3.2 Integration Testing Examples

**Example 1: Repository Integration Test**
```java
@SpringBootTest
@Transactional
class UserRepositoryIntegrationTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void testSave_WithValidUser_PersistsToDatabase() {
        // Arrange
        User user = new User("John", "john@example.com");
        
        // Act
        User saved = userRepository.save(user);
        
        // Assert
        assertNotNull(saved.getId());
        Optional<User> found = userRepository.findById(saved.getId());
        assertTrue(found.isPresent());
        assertEquals("John", found.get().getName());
    }
    
    @Test
    void testFindByEmail_WithExistingEmail_ReturnsUser() {
        // Arrange
        User user = new User("John", "john@example.com");
        userRepository.save(user);
        
        // Act
        Optional<User> found = userRepository.findByEmail("john@example.com");
        
        // Assert
        assertTrue(found.isPresent());
        assertEquals("John", found.get().getName());
    }
}
```

**Example 2: Service Integration Test**
```java
@SpringBootTest
@Transactional
class OrderServiceIntegrationTest {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    @MockBean
    private PaymentService paymentService;
    
    @Test
    void testCreateOrder_WithValidData_CreatesOrder() {
        // Arrange
        User user = userRepository.save(new User("John", "john@example.com"));
        OrderRequest request = new OrderRequest(user.getId(), Arrays.asList(
            new OrderItem("product1", 2, 10.0)
        ));
        
        when(paymentService.processPayment(any())).thenReturn(
            new PaymentResult(true, "Payment successful"));
        
        // Act
        Order order = orderService.createOrder(request);
        
        // Assert
        assertNotNull(order.getId());
        assertEquals(OrderStatus.CONFIRMED, order.getStatus());
        assertEquals(20.0, order.getTotal(), 0.01);
    }
}
```

**Example 3: REST Controller Integration Test**
```java
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
class UserControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void testGetUser_WithValidId_ReturnsUser() throws Exception {
        // Arrange
        User user = userRepository.save(new User("John", "john@example.com"));
        
        // Act & Assert
        mockMvc.perform(get("/api/users/" + user.getId()))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.name").value("John"))
            .andExpect(jsonPath("$.email").value("john@example.com"));
    }
    
    @Test
    void testCreateUser_WithValidData_CreatesUser() throws Exception {
        // Arrange
        String requestBody = """
            {
                "name": "Jane",
                "email": "jane@example.com"
            }
            """;
        
        // Act & Assert
        mockMvc.perform(post("/api/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestBody))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.name").value("Jane"));
    }
}
```

### 3.3 Test Containers for Integration Testing

```java
@SpringBootTest
@Testcontainers
class DatabaseIntegrationTest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:14")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void testSaveUser_WithRealDatabase_Success() {
        User user = new User("John", "john@example.com");
        User saved = userRepository.save(user);
        assertNotNull(saved.getId());
    }
}
```

---

## 4. End-to-End Testing

### 4.1 What is E2E Testing?

**Definition**: Test complete user workflows

**Characteristics**:
- Tests full system
- Slowest tests
- Most expensive
- Tests user journeys

### 4.2 E2E Testing Examples

**Example 1: Selenium Web Testing**
```java
@SpringBootTest(webEnvironment = WebEnvironment.DEFINED_PORT)
class UserRegistrationE2ETest {
    
    private WebDriver driver;
    
    @BeforeEach
    void setUp() {
        driver = new ChromeDriver();
    }
    
    @AfterEach
    void tearDown() {
        if (driver != null) {
            driver.quit();
        }
    }
    
    @Test
    void testUserRegistration_CompleteFlow_Success() {
        // Navigate to registration page
        driver.get("http://localhost:8080/register");
        
        // Fill form
        driver.findElement(By.id("name")).sendKeys("John Doe");
        driver.findElement(By.id("email")).sendKeys("john@example.com");
        driver.findElement(By.id("password")).sendKeys("password123");
        
        // Submit
        driver.findElement(By.id("submit")).click();
        
        // Verify success
        WebElement successMessage = driver.findElement(By.id("success-message"));
        assertTrue(successMessage.isDisplayed());
        assertEquals("Registration successful!", successMessage.getText());
    }
}
```

**Example 2: API E2E Testing**
```java
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
class OrderProcessingE2ETest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private ProductRepository productRepository;
    
    @Test
    void testOrderProcessing_CompleteFlow_Success() {
        // 1. Create user
        User user = userRepository.save(new User("John", "john@example.com"));
        
        // 2. Create product
        Product product = productRepository.save(
            new Product("Laptop", 999.99));
        
        // 3. Create order
        OrderRequest request = new OrderRequest(user.getId(), Arrays.asList(
            new OrderItem(product.getId(), 1, product.getPrice())
        ));
        
        ResponseEntity<Order> orderResponse = restTemplate.postForEntity(
            "/api/orders", request, Order.class);
        
        assertEquals(HttpStatus.CREATED, orderResponse.getStatusCode());
        Order order = orderResponse.getBody();
        assertNotNull(order);
        assertEquals(OrderStatus.CONFIRMED, order.getStatus());
        
        // 4. Verify order exists
        ResponseEntity<Order> getResponse = restTemplate.getForEntity(
            "/api/orders/" + order.getId(), Order.class);
        
        assertEquals(HttpStatus.OK, getResponse.getStatusCode());
        assertNotNull(getResponse.getBody());
    }
}
```

**Example 3: Cypress E2E Testing**
```javascript
describe('User Registration Flow', () => {
  it('should register a new user successfully', () => {
    cy.visit('/register');
    
    cy.get('#name').type('John Doe');
    cy.get('#email').type('john@example.com');
    cy.get('#password').type('password123');
    cy.get('#submit').click();
    
    cy.url().should('include', '/dashboard');
    cy.get('.success-message').should('contain', 'Registration successful');
  });
  
  it('should show error for invalid email', () => {
    cy.visit('/register');
    
    cy.get('#name').type('John Doe');
    cy.get('#email').type('invalid-email');
    cy.get('#password').type('password123');
    cy.get('#submit').click();
    
    cy.get('.error-message').should('contain', 'Invalid email');
  });
});
```

---

## 5. Test-Driven Development (TDD)

### 5.1 TDD Cycle

```
1. Red: Write failing test
   ↓
2. Green: Write minimal code to pass
   ↓
3. Refactor: Improve code while keeping tests green
   ↓
   Repeat
```

### 5.2 TDD Example

**Step 1: Red - Write Failing Test**
```java
@Test
void testCalculateDiscount_HighOrder_Returns10Percent() {
    DiscountCalculator calculator = new DiscountCalculator();
    double discount = calculator.calculateDiscount(1500.0);
    assertEquals(150.0, discount, 0.01);
}
```

**Step 2: Green - Write Minimal Code**
```java
class DiscountCalculator {
    public double calculateDiscount(double total) {
        if (total > 1000) {
            return total * 0.1;
        }
        return 0.0;
    }
}
```

**Step 3: Refactor - Improve Code**
```java
class DiscountCalculator {
    private static final double HIGH_THRESHOLD = 1000.0;
    private static final double HIGH_DISCOUNT_RATE = 0.1;
    
    public double calculateDiscount(double total) {
        if (total > HIGH_THRESHOLD) {
            return total * HIGH_DISCOUNT_RATE;
        }
        return 0.0;
    }
}
```

**Step 4: Add More Tests**
```java
@Test
void testCalculateDiscount_MediumOrder_Returns5Percent() {
    DiscountCalculator calculator = new DiscountCalculator();
    double discount = calculator.calculateDiscount(750.0);
    assertEquals(37.5, discount, 0.01);
}
```

**Step 5: Update Implementation**
```java
class DiscountCalculator {
    private static final double HIGH_THRESHOLD = 1000.0;
    private static final double MEDIUM_THRESHOLD = 500.0;
    private static final double HIGH_DISCOUNT_RATE = 0.1;
    private static final double MEDIUM_DISCOUNT_RATE = 0.05;
    
    public double calculateDiscount(double total) {
        if (total > HIGH_THRESHOLD) {
            return total * HIGH_DISCOUNT_RATE;
        } else if (total > MEDIUM_THRESHOLD) {
            return total * MEDIUM_DISCOUNT_RATE;
        }
        return 0.0;
    }
}
```

### 5.3 TDD Benefits

- **Better Design**: Forces good design
- **Confidence**: Tests provide safety net
- **Documentation**: Tests document behavior
- **Regression Prevention**: Catch bugs early

---

## 6. Testing Best Practices

### 6.1 Test Organization

```java
/**
 * Test Organization:
 * 
 * src/
 *   main/
 *     java/
 *       com/example/
 *         service/
 *           UserService.java
 *   test/
 *     java/
 *       com/example/
 *         service/
 *           UserServiceTest.java
 *         integration/
 *           UserServiceIntegrationTest.java
 *         e2e/
 *           UserRegistrationE2ETest.java
 */
```

### 6.2 Test Naming Conventions

```java
/**
 * Test Naming:
 * 
 * Format: test[MethodName]_[Scenario]_[ExpectedBehavior]
 * 
 * Examples:
 * - testCreateUser_WithValidData_ReturnsUser
 * - testCreateUser_WithInvalidEmail_ThrowsException
 * - testCalculateDiscount_HighOrder_Returns10Percent
 */
```

### 6.3 Test Data Management

```java
class TestDataBuilder {
    
    public static User.UserBuilder aUser() {
        return User.builder()
            .id("test-id")
            .name("Test User")
            .email("test@example.com");
    }
    
    public static Order.OrderBuilder anOrder() {
        return Order.builder()
            .id("order-id")
            .userId("user-id")
            .total(100.0);
    }
}

// Usage
@Test
void testCreateUser_Success() {
    User user = TestDataBuilder.aUser()
        .name("John")
        .email("john@example.com")
        .build();
    // ...
}
```

### 6.4 Test Isolation

```java
@ExtendWith(MockitoExtension.class)
class IsolatedTest {
    
    @Mock
    private Dependency dependency;
    
    @InjectMocks
    private ServiceUnderTest service;
    
    @Test
    void testMethod() {
        // Each test is isolated
        // No shared state
    }
}
```

### 6.5 Test Coverage Goals

```java
/**
 * Coverage Goals:
 * 
 * - Overall: 80%+
 * - Critical Paths: 90%+
 * - Business Logic: 85%+
 * - Utilities: 70%+
 * 
 * Focus on:
 * - Happy paths
 * - Error cases
 * - Edge cases
 * - Boundary conditions
 */
```

---

## 7. Practical Examples

### 7.1 Complete Testing Strategy

```java
/**
 * Complete Testing Strategy:
 * 
 * 1. Unit Tests (70%):
 *    - Service logic
 *    - Utility methods
 *    - Business rules
 * 
 * 2. Integration Tests (20%):
 *    - Repository tests
 *    - Service integration
 *    - API integration
 * 
 * 3. E2E Tests (10%):
 *    - Critical user journeys
 *    - Complete workflows
 *    - System integration
 */
```

### 7.2 Testing Checklist

```java
/**
 * Testing Checklist:
 * 
 * Unit Tests:
 * □ All public methods tested
 * □ Edge cases covered
 * □ Error cases covered
 * □ Mocks used appropriately
 * 
 * Integration Tests:
 * □ Database operations tested
 * □ External services mocked
 * □ API endpoints tested
 * 
 * E2E Tests:
 * □ Critical user journeys
 * □ Complete workflows
 * □ Error scenarios
 */
```

---

## Summary: Part 3

### Key Takeaways

1. **Testing Pyramid**: 70% unit, 20% integration, 10% E2E
2. **Unit Tests**: Fast, isolated, test one thing
3. **Integration Tests**: Test component interaction
4. **E2E Tests**: Test complete user workflows
5. **TDD**: Red-Green-Refactor cycle

### Next Steps

**Part 4** will cover:
- Code Review Processes
- Review best practices
- Review tools
- Review metrics

---

**Master testing strategies for high-quality, reliable code!**

