# Drive - File Storage Architecture

## Document Information

| Field | Value |
|-------|-------|
| **Version** | 1.0 |
| **Status** | Draft |
| **Last Updated** | December 2025 |

---

## 1. Overview

### 1.1 What is Drive?

Drive is Phoenix platform's enterprise file storage service providing:

- **Secure storage** for multi-tenant file management
- **Compliance-ready** architecture for wealth management
- **Scalable design** supporting millions of files

### 1.2 Distribution Model

Drive is distributed in two forms:

| Interface | Consumers | Use Case |
|-----------|-----------|----------|
| **SDK (Go)** | Internal services, backend components | Direct integration, no network hop |
| **REST API** | UI, mobile apps, external clients | HTTP-based access |

```
┌─────────────────────────────────────────────────────────────────┐
│                       CONSUMERS                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Internal Services              External Clients               │
│   ┌─────────────────┐           ┌─────────────────┐            │
│   │ Doc Processing  │           │   Browser UI    │            │
│   │ Workflow Engine │           │   Mobile App    │            │
│   │ Report Service  │           │   Partner API   │            │
│   └────────┬────────┘           └────────┬────────┘            │
│            │                             │                      │
│            ▼                             ▼                      │
│   ┌─────────────────┐           ┌─────────────────┐            │
│   │   Drive SDK     │           │   Drive REST    │            │
│   │   (Go Module)   │           │   (HTTP API)    │            │
│   └────────┬────────┘           └────────┬────────┘            │
│            │                             │                      │
│            └──────────────┬──────────────┘                      │
│                           ▼                                     │
│                  ┌─────────────────┐                           │
│                  │   Drive Core    │                           │
│                  │   (Library)     │                           │
│                  └─────────────────┘                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**SDK Benefits:**
- No network latency for internal services
- Type-safe Go interfaces
- Direct access to Drive core functionality
- Compile-time dependency

**REST API Benefits:**
- Language-agnostic access
- Standard HTTP semantics
- Pre-signed URL generation for direct S3 uploads/downloads
- Suitable for UI and external integrations

### 1.3 Key Design Decisions

| Decision | Choice |
|----------|--------|
| Storage | AWS S3 (one bucket per cluster) |
| Metadata | PostgreSQL (Apps), MongoDB (Platform) |
| Public Access | CloudFront CDN |
| Private Access | Pre-signed URLs |
| File Distribution | 3-character hash prefix (~4,096 folders) |

---

## 2. Architecture

### 2.1 System Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                          CLIENTS                                │
├───────────────────────────────┬─────────────────────────────────┤
│     Internal Services         │        External Clients         │
│  (Doc Proc, Workflow, etc.)   │    (Browser, Mobile, Partners)  │
└───────────────┬───────────────┴────────────────┬────────────────┘
                │                                │
                ▼                                ▼
┌───────────────────────────┐    ┌───────────────────────────────┐
│       Drive SDK           │    │         API Gateway           │
│       (Go Module)         │    │  Auth · Rate Limit · Validate │
└───────────────┬───────────┘    └───────────────┬───────────────┘
                │                                │
                │                                ▼
                │                ┌───────────────────────────────┐
                │                │       Drive REST API          │
                │                │       (HTTP Handlers)         │
                │                └───────────────┬───────────────┘
                │                                │
                └────────────────┬───────────────┘
                                 ▼
                ┌───────────────────────────────────────┐
                │            Drive Core                 │
                │  ┌─────────────────────────────────┐  │
                │  │  File Service · Storage Provider │  │
                │  │  Validator · Retention · Audit   │  │
                │  └─────────────────────────────────┘  │
                └───────────────────┬───────────────────┘
                                    │
                ┌───────────────────┴───────────────┐
                ▼                                   ▼
┌───────────────────────────┐       ┌───────────────────────────┐
│        CloudFront         │       │          S3 Bucket        │
│      (Public Files)       │       │      (All Files)          │
│                           │       │                           │
│  • GLOBAL/*               │       │  ┌────────┐ ┌──────────┐  │
│  • PLATFORM/*             │       │  │ GLOBAL │ │ PLATFORM │  │
└───────────────────────────┘       │  └────────┘ └──────────┘  │
                                    │  ┌──────────┐             │
                                    │  │  TENANT  │             │
                                    │  └──────────┘             │
                                    └───────────────────────────┘
```

### 2.2 Library Integration Model

All core Phoenix modules include Drive as a **library dependency** rather than calling it as a separate service.

```
┌─────────────────────────────────────────────────────────────────┐
│                     CORE MODULE (e.g., Workflow)                │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    Business Logic                        │   │
│   │                                                          │   │
│   │   // Direct library call - no HTTP, no network hop       │   │
│   │   file, err := drive.Upload(ctx, request)                │   │
│   │   url, err := drive.GetDownloadURL(ctx, fileID)          │   │
│   │                                                          │   │
│   └─────────────────────────┬───────────────────────────────┘   │
│                             │                                    │
│   ┌─────────────────────────▼───────────────────────────────┐   │
│   │                  Drive Library                           │   │
│   │           (compiled into the module)                     │   │
│   └─────────────────────────┬───────────────────────────────┘   │
│                             │                                    │
└─────────────────────────────┼────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │       S3        │
                    └─────────────────┘
```

**Benefits:**

| Benefit | Description |
|---------|-------------|
| **Zero latency** | No network round-trip, function runs in-process |
| **Type safety** | Compile-time checks, IDE autocompletion |
| **Simpler deployment** | No separate Drive service to deploy/manage |
| **Atomic operations** | Can participate in same transaction context |

> See [Addendum F: Library Integration](detailed-design.md#addendum-f-library-integration) for code examples.

### 2.3 Component Responsibilities

| Component | Responsibility |
|-----------|----------------|
| **Drive Library** | Go module compiled into core services, direct S3 access |
| **Drive REST API** | HTTP endpoints for external clients, pre-signed URL generation |
| **API Gateway** | Authentication, rate limiting, request validation (REST only) |
| **CloudFront** | CDN for public files (GLOBAL, PLATFORM) |
| **S3** | Object storage for all files |

### 2.4 REST Interface

**REST API:**

```
POST   /api/v1/files/upload/initiate    → Get pre-signed upload URL
POST   /api/v1/files/upload/complete    → Confirm upload completion
GET    /api/v1/files/{id}               → Get file metadata
POST   /api/v1/files/{id}/download      → Get pre-signed download URL
DELETE /api/v1/files/{id}               → Delete file
GET    /api/v1/files?account_id=...     → List files
```

### 2.5 Scope Hierarchy

| Scope | Content | Access Method |
|-------|---------|---------------|
| **GLOBAL** | Shared reference data, certificates | CloudFront (Public) |
| **PLATFORM** | UI assets, templates, configs | CloudFront (Public) |
| **TENANT** | Client documents, PII | Pre-signed URLs (Private) |

### 2.6 Supporting Multiple Storage Backends

**Abstraction Layer**

For now its just a provision in design so that its extensible in future.

```
┌─────────────────────────────────────────────────────────────────┐
│                      DRIVE API SERVICE                          │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STORAGE PROVIDER INTERFACE                    │
│                                                                 │
│   upload()  download()  delete()  list()  get_url()  exists()  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  S3 Provider │    │ Box Provider │    │ SFTP Provider│
└──────────────┘    └──────────────┘    └──────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   AWS S3     │    │   Box API    │    │  SFTP Server │
└──────────────┘    └──────────────┘    └──────────────┘
```

---

## 3. Storage Structure

### 3.1 Bucket Layout

```
S3_Bucket/
│
├── GLOBAL/                                      ← Shared across all
│   └── certificates/
│       └── abc/                                 ← hash[0:2] (3 chars)
│           └── abc123def456.pem                 ← CAS filename
│
├── PLATFORM/                                    ← Shared across tenants
│   │
│   ├── common/                                  ← Shared across services
│   │   ├── fonts/
│   │   │   └── abc/
│   │   │       └── abc123def456.woff2
│   │   └── icons/
│   │       └── 1f2/
│   │           └── 1f2e3d4c5b6a.svg
│   │
│   ├── ui/                                      ← UI service
│   │   ├── js/
│   │   │   └── 7ab/
│   │   │       └── 7ab8c9d0e1f2.js
│   │   ├── css/
│   │   │   └── 3cd/
│   │   │       └── 3cd4e5f6a7b8.css
│   │   └── assets/
│   │       └── images/
│   │           └── e5f/
│   │               └── e5f6a7b8c9d0.png
│   │
│   ├── workflow/                                ← Workflow service
│   │   └── templates/
│   │       └── email/
│   │           └── 9ef/
│   │               └── 9ef0a1b2c3d4.html
│   │
│   └── docproc/                                 ← Doc processing service
│       └── configs/
│           └── 5a6/
│               └── 5a6b7c8d9e0f.json
│
└── TENANT/                                      ← Tenant-specific (PII)
    └── {Tenant}_{id}/
        └── {App}_{id}/
            └── {hash[0:2]}/                     ← 3-char distribution
                └── files...
```

Note: Please note that we have taken a decision to keep the ui artefact bucket separate from the phoenix drive bucket. Since UI build and deployment will manage its own structure and build pipeline.
effectively we will have two buckets

ui-phoenix-drive (thats the name already given)
phoenix-drive

### 3.2 Storage Key Pattern

**PLATFORM (CAS-based, public assets):**
```
PLATFORM/{service}/{custom_path}/{hash[0:2]}/{content_hash}.{ext}

Examples:
PLATFORM/ui/js/7ab/7ab8c9d0e1f2.js
PLATFORM/common/fonts/abc/abc123def456.woff2
PLATFORM/workflow/templates/email/9ef/9ef0a1b2c3d4.html
```

**Rules:**
| Rule | Description |
|------|-------------|
| `common/` | Shared resources (fonts, icons) |
| Service folders | `ui/`, `workflow/`, `docproc/`, etc. |
| Custom structure | Services define their own hierarchy above hash level |
| Last level | Hash-based: `{hash[0:2]}/` (3 chars) |
| Filename | CAS-based (content hash): `{content_hash}.{ext}` |

**TENANT (private files):**
```
TENANT/{Tenant}_{id}/{App}_{id}/{hash[0:2]}/{filename}

Example:
TENANT/Axos_a1b2c3d4/Servicing_m3n4o5p6/1a1/acct_78234565_tax_1099.pdf
```

### 3.3 Hash-Based Distribution

Files are distributed using the first 3 characters of a content hash (`hash[0:2]`):

- **4,096 possible folders** (16³)
- **~244 files per folder** at 1M files scale
- **Even distribution** regardless of naming patterns
- CAS filename ensures deduplication and infinite cacheability

---

## 4. Access Patterns

### 4.1 Public Files (CloudFront)

```
┌────────┐         ┌─────────────┐         ┌────────┐
│ Client │ ──────► │ CloudFront  │ ──────► │   S3   │
└────────┘         └─────────────┘         └────────┘
                          │
                   ┌──────┴──────┐
                   │ Edge Cache  │
                   └─────────────┘

URL: https://cdn.company.com/PLATFORM/ui/js/7ab/7ab8c9d0e1f2.js
```

**Used for:** UI assets, templates, configs, public documents (as applicable)

### 4.2 Private Files (Pre-signed URLs)

```
┌────────┐  1.Request  ┌─────────┐  2.Generate  ┌────────┐
│ Client │ ──────────► │   API   │ ◄──────────► │   S3   │
└────────┘             └─────────┘              └────────┘
    │                                                ▲
    │ 3. Upload/Download with pre-signed URL         │
    └────────────────────────────────────────────────┘

URL: https://bucket.s3.amazonaws.com/...?X-Amz-Signature=...
```

**Used for:** Client documents, PII, account statements

### 4.3 Access Type by Scope

| Scope | Classification | Access | URL Expiry |
|-------|----------------|--------|------------|
| GLOBAL | Any | CloudFront | N/A |
| PLATFORM | PUBLIC/INTERNAL | CloudFront | N/A |
| PLATFORM | CONFIDENTIAL+ | Pre-signed | 5-15 min |
| TENANT | Any | Pre-signed | 5-15 min |

---

## 5. Security Model

### 5.1 Defense Layers

> **Note:** What we build up front needs careful consideration

```
┌─────────────────────────────────────────────────────────────────┐
│  Layer 1: Rate Limiting       10 uploads/min per user          │
├─────────────────────────────────────────────────────────────────┤
│  Layer 2: Filename Validation  Server generates UUID filename   │
├─────────────────────────────────────────────────────────────────┤
│  Layer 3: Extension Allowlist  pdf, png, jpg, xlsx, docx, csv  │
├─────────────────────────────────────────────────────────────────┤
│  Layer 4: MIME Validation      Content-Type must match          │
├─────────────────────────────────────────────────────────────────┤
│  Layer 5: Magic Number Check   First bytes verify file type     │
├─────────────────────────────────────────────────────────────────┤
│  Layer 6: Size Limits          100 MB per file, 1 GB per day    │
├─────────────────────────────────────────────────────────────────┤
│  Layer 7: Virus Scanning       (Optional) Async scan            │
├─────────────────────────────────────────────────────────────────┤
│  Layer 8: Content Sanitization (Optional) Strip EXIF, PDF scripts│
└─────────────────────────────────────────────────────────────────┘
```

**Layers 1-6:** Required, validated before/during upload  
**Layers 7-8:** Optional, can be enabled per tenant/classification

### 5.2 S3 Bucket Security

| Control | Setting |
|---------|---------|
| Public Access | **Blocked** |
| Directory Listing | **Denied** |
| Encryption | SSE-KMS |
| Access | CloudFront OAC + API Role only |

### 5.3 Authorization Flow

```
Request → Authenticate → Verify Tenant → Check Ownership → Check Status → Grant/Deny
```

Every file access verifies:

1. User is authenticated
2. User's tenant matches file's tenant
3. User owns file or has permission
4. File status is ACTIVE

---

## 6. Metadata Update and Consistency

### 6.1 Write Path (Upload First, Then Metadata)

```
1. Upload to S3 (with retention tag)
2. On success → Write metadata to DB (with retries)
3. If retries exhausted → Dead Letter Queue
4. Weekly → S3 Inventory reconciliation
```

**Why this approach:**
- Single DB write per file (not two)
- Fewer failure points
- No background jobs for archival/deletion
- S3 Inventory reconciliation catches edge cases

### 6.2 Retry Strategy

| Stage | Strategy |
|-------|----------|
| Immediate | 3-5 retries with exponential backoff |
| If exhausted | Push to Dead Letter Queue |
| DLQ Processing | Async retry with alerting |
| Final safety net | Weekly S3 Inventory reconciliation |

### 6.3 Lifecycle Management

**S3 handles archival and deletion automatically via Lifecycle Rules.**

| Event | Handled By | DB Metadata |
|-------|------------|-------------|
| Archive to Glacier | S3 Lifecycle (by tag/prefix) | `archive_at` tells you when |
| Delete expired files | S3 Lifecycle (by tag) | `delete_at` tells you when |
| Legal Hold | S3 Object Lock + DB flag | Synced on hold change |

**On File Access:**
- Check `delete_at` in DB → if past, verify with S3 → reconcile if needed
- Check `archive_at` in DB → if past, file is in Glacier (restore if needed)

### 6.4 Reconciliation (Weekly)

Using S3 Inventory reports (not LIST API):

| Check | Action |
|-------|--------|
| File in S3, not in DB | Flag for review (orphan) |
| File in DB, not in S3 | Mark as `DELETED` in DB |
| Storage class changed | Update `status` to `ARCHIVED` |

---

## 7. Metadata

### 7.1 Core Fields

| Group | Fields |
|-------|--------|
| **Identity** | scope, tenant_id, app_id, owner_id, account_id, tags |
| **File** | file_name, extension, size_bytes, mime_type, content_hash |
| **Storage** | bucket, storage_key, storage_class, is_encrypted |
| **Access** | access_type, is_public, cdn_url, signed_url_expiry |
| **Retention** | retention_policy, archive_at, delete_at, legal_hold |
| **Classification** | classification (PII_HIGH, CONFIDENTIAL, INTERNAL, PUBLIC) |
| **Audit** | version, created_at, updated_at, request_id |

### 7.2 Classification & Retention

| Classification | Description | Default Retention |
|----------------|-------------|-------------------|
| PII_HIGH | Government IDs, SSN | 7 years |
| CONFIDENTIAL | Financial statements | 7 years |
| INTERNAL | Internal documents | 3 years |
| PUBLIC | Public assets | No limit |

**Retention Patterns (S3 Managed):**

```
Pattern 1: Simple Expiry (TEMP_7_DAYS)
────────────────────────────────────────
Upload ─────────────────────────► Delete
Day 0                              Day 7
        (S3 Lifecycle Rule)


Pattern 2: Archive then Delete (COMPLIANCE_7_YEAR)
────────────────────────────────────────────────────
Upload ──────────► Archive ──────────────────► Delete
Day 0              Day 180                    Year 7
                (S3 Lifecycle)            (S3 Lifecycle)
```

- S3 tags set at upload (`retention=TEMP_7_DAYS`, `retention=COMPLIANCE_7_YEAR`)
- S3 Lifecycle Rules handle transitions and expiration
- DB fields (`archive_at`, `delete_at`) are predictive - tell you what *should* happen
- On file access, reconcile with S3 if dates indicate change

**Legal Hold:**
- When set: Update DB `legal_hold=true` + Enable S3 Object Lock
- When removed: Update DB `legal_hold=false` + Disable S3 Object Lock
- S3 Object Lock prevents deletion regardless of lifecycle rules

### 7.3 WORM Storage Support

Drive supports **Write Once Read Many (WORM)** storage for regulatory compliance requirements (SEC 17a-4, FINRA, etc.).

**WORM Modes:**

| Mode | Description | Use Case |
|------|-------------|----------|
| **Governance** | Privileged users can override | Internal compliance, flexible retention |
| **Compliance** | No one can delete (including root) | Regulatory requirements (SEC 17a-4) |

**WORM Retention:**

```
Upload with WORM ──────────────────────────────► Retention Expires
     │                                                    │
     │  Immutable Period (no modifications/deletions)     │
     │◄──────────────────────────────────────────────────►│
     │                                                    ▼
     │                                            File can be deleted
```

**Implementation:**
- S3 Object Lock with retention period set at upload time
- Compliance mode for SEC 17a-4 regulated documents
- Governance mode for internal compliance policies
- Retention periods: 3 years, 5 years, 7 years (configurable)
- Cannot be shortened once applied (can be extended in Governance mode)

---

## 8. Large File Handling

### 8.1 Size Thresholds

| Size | Strategy |
|------|----------|
| < 100 MB | Single PUT |
| 100 MB - 5 GB | Multipart Upload |
| > 5 GB | Multipart (mandatory) |

### 8.2 Multipart Flow

```
1. Request upload → API returns upload_id + part URLs
2. Client uploads parts in parallel
3. Client sends completion with ETags
4. API completes multipart
5. Single metadata entry created
```

---

## 9. Scalability

### 9.1 Current Limits

| Resource | Limit |
|----------|-------|
| Objects per bucket | Unlimited |
| Object size | 5 TB |
| PUT requests/prefix | 3,500/sec |
| GET requests/prefix | 5,500/sec |

### 9.2 Growth Path

| Scale | Strategy |
|-------|----------|
| < 1M files | Current design |
| 1M - 10M | Add database partitioning |
| 10M+ | Consider bucket-per-tenant |

### 9.3 Cost Optimization

- **S3 Intelligent-Tiering** for mixed access patterns
- **Glacier** for compliance archives (180+ days)
- **S3 Inventory** instead of LIST API for audits

---

## 10. Quick Reference

### 10.1 URL Patterns

| Type | Pattern |
|------|---------|
| CloudFront | `https://cdn.company.com/{storage_key}` |
| Pre-signed | `https://{bucket}.s3.amazonaws.com/{key}?X-Amz-Signature=...` |
| S3 URI | `s3://{bucket}/{storage_key}` |

### 10.2 Expiry Guidelines

| Classification | Upload URL | Download URL |
|----------------|------------|--------------|
| PII_HIGH | 15 min | 5 min |
| CONFIDENTIAL | 30 min | 10 min |
| INTERNAL | 60 min | 15 min |

### 10.3 Blocked Extensions

```
exe, dll, bat, cmd, msi, js, vbs, ps1, sh, php, py,
html, htm, svg, swf, jar, war, xlsm, docm, lnk
```

---

## Addendums

| Addendum | Content |
|----------|---------|
| [A. Schema Definition](detailed-design.md#addendum-a-schema-definition) | Complete PostgreSQL schema, indexes, triggers |
| [B. Security Details](detailed-design.md#addendum-b-security-details) | Bucket policies, CORS, security matrix |
| [C. File Type Reference](detailed-design.md#addendum-c-file-type-reference) | Allowed types, MIME types, magic numbers |
| [D. Sample Queries](detailed-design.md#addendum-d-sample-queries) | Common database queries |
| [E. API Reference](detailed-design.md#addendum-e-api-reference) | Endpoint specifications |
| [F. Library Integration](detailed-design.md#addendum-f-library-integration) | Go module integration, code examples |

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | Dec 2025 | Initial draft |
